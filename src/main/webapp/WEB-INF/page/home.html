<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        html{
            width: 100%;
            height: 100%;
        }
        body{
            background-color: #F7F8F5;
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        .layui-layout-admin .layui-body{
            top: 80px;
            width: 100%;
            left: 0;
        }
        .table_fl {
            width: 10%;
            color: #ef741c;
            height: 30px;
        }
        .table_bt {
            width: 50%;
            cursor:pointer;
            text-align: left;
        }
        .table_zz {
            width: 20%;
            color: #999;
        }
        .table_sj {
            width: 20%;
            color: #999;
        }
        .layui-upload-img{
            width: 150px;
            height: 100px;
        }
    </style>
    <link rel="stylesheet" href="/ssm_Demo/static/dist/css/layui.css">
</head>
<body>
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">

        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item"><a href="javaScript:void (0)" onclick="startCj()">发起筹集</a></li>
            <li class="layui-nav-item">
                <a href="javascript:;">
                        <#if (Session.userInfo)??>
                                <img src="${Session.userInfo.avatar}" class="layui-nav-img">
                                ${Session.userInfo.name}
                        </#if>

                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:void(0);" onclick="perfectInfo()">基本资料</a></dd>
                    <dd><a href="">修改密码</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a href="javascript:void(0);" onclick="outLogin()">退出</a></li>
        </ul>



    </div>
    <div class="layui-body" >
        <div style="width: 48%;height: 48%;border: 2px solid #B5B5B5;float: left;margin-left: 1%" id="carouselDiv">
            <div class="layui-carousel" id="carousel" lay-filter="carousel">
                <div carousel-item id="carousel_item">
                </div>
            </div>
        </div>

        <div style="width: 48%;height: 48%;border: 2px solid #B5B5B5;float: left;margin-left: 2%" id="undoneDiv">
            <div class="layui-tab layui-tab-card">
                <ul class="layui-tab-title" >
                    <li class="layui-this">公益列表</li>
                    <!-- <li>用户管理</li>
                     <li>权限分配</li>
                     <li>商品管理</li>
                     <li>订单管理</li>-->
                </ul>
                <div class="layui-tab-content" >
                    <div class="layui-tab-item layui-show">
                        <table style="width: 100%;text-align: center" id="table1">

                        </table>
                        <div id="laypage1"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="width: 98%;height: 48%;border: 2px solid #B5B5B5;float: left;margin-left: 1%;margin-top: 1%">
            <table style="width: 100%;height: 80%; text-align: center" id="table2">

            </table>
            <div id="laypage2" style="margin-left: 50px;margin-top: 30px"></div>
        </div>
    </div>

    <div class="layui-footer" style="text-align: center;font-size: 0.3em;color:#B5B5B5;left: 0px">
        <input type="hidden" id="urlPath" value="">
        为了获得最佳操作体验，建议您使用最新版本的浏览器，支持1920 × 1080 以上分辨率
    </div>

</div>
</body>
<script src="/ssm_Demo/static/dist/layui.all.js" type="text/javascript"></script>
<script src="/ssm_Demo/static/jquery/jquery.min.js" type="text/javascript"></script>
<script>
    //JavaScript代码区域
    let tabWindowHeight=0;
    let element,carousel,form,table,laypage;
         element = layui.element,
         carousel = layui.carousel
        ,form = layui.form
        ,table  =layui.table
        ,laypage= layui.laypage
    let layer=layui.layer;
    let upload=layui.upload;

    let content='<div class="layui-form layui-form-pane" >  ' +
        '<div class="layui-form-item" style="margin-left: 10%"><label class="layui-form-label">请输入：</label> <div class="layui-input-block"> <input type="number" name="money" id="money" required  lay-verify="required" placeholder="请输入金额" class="layui-input" style="width: 300px" oninput="changeIntValue(this)"> </div> </div> ' +
        '<div class="layui-form-item" style="margin-left: 10%"><label class="layui-form-label">标题：</label> <div class="layui-input-block"> <input type="text" name="title" id="title" required  lay-verify="required" placeholder="请输入标题" class="layui-input" style="width: 300px" oninput="changeIntValue(this)"> </div> </div> ' +
        '<div class="layui-form-item layui-form-text" style="margin-left: 10%"><label class="layui-form-label" style="width: 80%">描述：</label> <div class="layui-input-block"> <textarea name="describe" id="describe" placeholder="请输入内容" class="layui-textarea" style="width: 80%"></textarea> </div> </div> ' +
        '<div class="layui-form-item layui-form-text" style="margin-left: 10%">   ' +
        '       <div class="layui-upload">\n' +
        '            <button type="button" class="layui-btn" id="test2">多图片上传</button>\n' +
        '           <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;"> 预览图：\n' +
        '                <div class="layui-upload-list" id="demo2"></div>\n' +
        '            </blockquote>\n' +
        '        </div></div> ' +
        '</div>'

    //初始化页面，加载数据
    function init(){
        $.post('/ssm_Demo/article/getList',{status:1,curr:1,limit:7},function(res){
            //console.log(res);
            drawTable("#table1",res.page.records);
            laypage.render({
                elem: 'laypage1' //注意，这里的 test1 是 ID，不用加 # 号
                ,count: res.page.total //数据总数，从服务端得到
                ,limit:7
                ,jump:function (obj,first) {
                    if(!first){
                        let res= getList({status:1,curr:obj.curr,limit:obj.limit})
                        drawTable("#table1",res.page.records);
                    }
                }
            });
        });


        $.post('/ssm_Demo/article/getList',{status:0,curr:1,limit:10},function(res){
            //console.log(res);
            drawTable("#table2",res.page.records);
            laypage.render({
                elem: 'laypage2' //注意，这里的 test1 是 ID，不用加 # 号
                ,count: res.page.total //数据总数，从服务端得到
                ,limit:10
                ,jump:function (obj,first) {
                    if(!first){
                        let res= getList({status:1,curr:obj.curr,limit:obj.limit})
                        drawTable("#table2",res.page.records);
                    }
                }
            });
        });

        $.post("/ssm_Demo/article/getSlideShow",{},function(res){
            let SlideShow=res.SlideShow;
            for (let i=0;i<SlideShow.length;i++){
                $("#carousel_item").append("<div ><img src='/ssm_Demo/"+SlideShow[i].photos+"' style='cursor:pointer;width: 100%;height: 100%;' onclick='goDetilPage("+SlideShow[i].id+")'> </div>");
            }
            //常规轮播
            carousel.render({
                elem: '#carousel'
                ,arrow: 'hover'
                ,height:'100%'
                ,width:'100%'
            });
        });
    }

    //监听表单数据，标题和筹款金额
    function changeIntValue(item){
         let lableId=$(item).attr("id");
         let value=$(item).val();
         switch (lableId) {
             case "title":
                 if(value.length>25){
                     $(item).val(value.substring(0,25));
                     alert("限制最大输入25！！")
                 }
                 break;
             case "money":
                 $(item).val(value.replace(/[^0-9]/g, ''));
                 break;
         }
    }


    //请求列表数据
    function getList(item){
        let returnVal;
        $.ajax({
            url:'/ssm_Demo/article/getList',async:false,type:"POST",data:item,success:function(res){
                returnVal=res;
            }
        });
        return returnVal;
    }

    //请求返回数据后绘制表格
    function drawTable(tableId,data){
        $(tableId).html("");
        let tableTd="[待筹款]";
        if(tableId==="table2"){tableTd="[已完结]";}
        for(let i=0;i<data.length;i++){
            let tr="<tr onclick='goDetilPage("+data[i].id+")'><td class='table_fl'>"+tableTd+"</td><td class='table_bt'>"+data[i].title+"</td> <td class='table_zz'>"+data[i].auth+"</td> <td class='table_sj'>"+data[i].createtime+"</td></tr>"
            $(tableId).append(tr);
        }
    }


    //初始化
    $(function(){
        let undoneDivHeight=$("#undoneDiv").css("height");
        undoneDivHeight=undoneDivHeight.substring(0,undoneDivHeight.length-2);
        let tabTileHeight=$(".layui-tab-title").css("height");
        tabTileHeight=tabTileHeight.substring(0,tabTileHeight.length-2);
        tabWindowHeight=undoneDivHeight -tabTileHeight-30;
        $(".layui-tab-content").css("height",tabWindowHeight);
        $("#table1").css("height",tabWindowHeight-40);
        init();
    });

    //转到详细页面
    function goDetilPage(articleId){
        window.location.href="/ssm_Demo/article/article.html?articleId="+articleId;
    }

    //退出登录
    function outLogin(){
        $.ajax({
            url: "/ssm_Demo/user/outLogin",
            async: true,
            data:"",
            success: function(data) {
                console.log("data");
                location.href = "/ssm_Demo/index.html";
            },
            type: "post",
            dataType: "json"
        })
    }

    //完善个人信息
    function perfectInfo(){
        console.log(11111)
        //调出弹出层
        layer.open({
            type:1,
            title: '完善个人信息',
            btn:[],
            closeBtn:"1",
            shadeClose:false,
            area: ['500px', '800px'],
            content:
                '<div style="padding: 20px 20px 20px 20px;">\n' +

                '<div class="layui-upload">\n' +
                '<button type="button" class="layui-btn" id="test1">上传图片</button>\n' +
                '<div class="layui-upload-list">\n' +
                '<img class="layui-upload-img" id="demo1">\n' +
                '<p id="demoText"></p>\n' +
                '</div>\n' +
                '</div>   \n' +

                '<form class="layui-form" action="" id="wanshanxinxi">\n' +
                '  <div class="layui-form-item">\n' +
                '    <label class="layui-form-label">姓名</label>\n' +
                '    <div class="layui-input-block">\n' +
                '      <input type="text" name="name" lay-verify="required" autocomplete="off" placeholder="请输入标题" class="layui-input">\n' +
                '    </div>\n' +
                '  </div>\n' +
                '  <div class="layui-form-item">\n' +
                '    <label class="layui-form-label">年龄</label>\n' +
                '    <div class="layui-input-block">\n' +
                '      <input type="text" name="age" lay-verify="required" autocomplete="off" placeholder="请输入标题" class="layui-input">\n' +
                '    </div>\n' +
                '  </div>\n' +
                '  <div class="layui-form-item">\n' +
                '    <label class="layui-form-label">单选框</label>\n' +
                '    <div class="layui-input-block">\n' +
                '      <input type="radio" name="sex" value="1" title="男" checked="">\n' +
                '      <input type="radio" name="sex" value="0" title="女">\n' +
                '    </div>\n' +
                '  </div>\n' +
                '  <div class="layui-form-item layui-form-text">\n' +
                '    <label class="layui-form-label">个性签名</label>\n' +
                '    <div class="layui-input-block">\n' +
                '<textarea placeholder="选填" class="layui-textarea" name="sign"></textarea>\n' +
                '    </div>\n' +
                '  </div>\n' +
                ' <div class="layui-form-item layui-form-text">\n' +
                '<label class="layui-form-label">头像</label>\n' +
                '<div class="layui-input-block">\n' +
                ' <input id="upTouxiang" type="text" name="avatar" lay-verify="required" autocomplete="off" placeholder="" class="layui-input">\n' +
                '</div>\n' +
                '</div>\n' +
                '  <div class="layui-form-item">\n' +
                '    <div class="layui-input-block">\n' +
                '      <button type="button" class="layui-btn" lay-submit lay-filter="demoT" id="touxiang" >立即提交</button>\n' +
                '      <button type="reset" class="layui-btn layui-btn-primary">重置</button>\n' +
                '    </div>\n' +
                '  </div>\n' +
                '</form>\n' +
                '</div>',
            cancel: function(index, layero){
                if(confirm('确定要关闭么')){ //只有当点击confirm框的确定时，该层才会关闭
                    layer.close(index)
                }
                return false;
            }
        });
        form.render();
        //头像上传
        upload.render({
            elem: '#test1'
            ,url: 'user/upT'
            ,field:'photo'
            ,accept:'images'
            ,acceptMime: 'image/*'
            // ,auto:false                  //禁止自动
            // ,bindAction: '#touxiang'   //按钮触发上传
            ,before: function(obj){
                console.log(obj)
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    console.log(result)
                    $('#demo1').attr('src', result); //图片链接（base64）
                    $("#upTouxiang").val($('#demo1').attr('src'))
                });
            }
            ,done: function(res){
                //如果上传失败
                if(res.code > 0){
                    return layer.msg('上传失败');
                }
                //上传成功
            }

        });
    }
    //监听提交
    form.on('submit(demoT)', function(data){
        console.log("详细信息提交");
        return false;
    });

    //点击筹集按钮后的相应窗口
    function startCj(){
        $("#urlPath").val("");
         layer.open({
             type: 1,
             skin: 'layui-layer-molv',
             offset: 'auto',
             area: ['600px', '500px'],
             btn: ['确认', '取消',],
             btnAlign:'c',
             resize:false,
             content: content //这里content是一个普通的String
             ,yes: function(index, layero){
                 var money=$("#money").val();
                 var title=$("#title").val();
                 var describe=$("#describe").val();
                 var urlPath=$("#urlPath").val();
                 $.post("/ssm_Demo/article/saveArticle",{money:money,title:title,describe:describe,urlPath:urlPath},function(res){
                     if(res.code==200){
                         alert(res.msg);
                         layer.close(index);
                         window.location.href="/ssm_Demo/home.html";
                     }
                 });
             }
             ,btn2: function(index, layero){
                 //按钮【按钮二】的回调
                 $.post("/ssm_Demo/article/removeImg",{url:$('#urlPath').val()},function(res){
                     console.log(res);
                 });
                 //return false 开启该代码可禁止点击该按钮关闭
             }
             ,cancel: function(){
                 //右上角关闭回调
                 //return false; 开启该代码可禁止点击该按钮关闭
             },
         });

         //多图片上传
         upload.render({
             elem: '#test2'
             ,url: '/ssm_Demo/article/uoloadImg'
             ,multiple: true
             ,accept:'images'
             ,acceptMime: 'image/*'
             ,field:'photos'
             ,data:{url:function(){
                     return $("#urlPath").val();
                 }}
             ,before: function(obj){
                 let urlPathVal=$("#urlPath").val();
                 if(urlPathVal===""){
                     $.ajax({
                         url:'/ssm_Demo/article/genKey',async:false,type:"POST",success:function(res){
                             $("#urlPath").val(res.key);

                         }
                     });
                 }
                 //预读本地文件示例，不支持ie8
                 obj.preview(function(index, file, result){
                     $('#demo2').append('<img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
                 });
             }
         });
    }

</script>
</html>
